name: Build and push

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/flutter

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Lint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: images/base/Dockerfile

      - name: Extract version from tag and labels from Dockerfile
        id: vars
        run: |
          set -euo pipefail
          DOCKERFILE="images/base/Dockerfile"

          version="${GITHUB_REF_NAME:-}"
          [ -n "$version" ] || { echo "GITHUB_REF_NAME is empty; tagging is required for publish" >&2; exit 1; }

          labels=$(grep -Eo 'org\.opencontainers\.image\.(title|licenses|description|authors|vendor)=("[^"]*"|[^"[:space:]]+)' "$DOCKERFILE" | sed 's/^ *//')

          {
            echo "version=$version"
            for kv in $labels; do
              key=${kv%%=*}
              val=${kv#*=}
              val=${val#\"}; val=${val%\"}
              short=${key#org.opencontainers.image.}
              echo "${short}=${val}"
            done
          } >> "$GITHUB_OUTPUT"

      - name: Log version
        run: |
          echo "Building Flutter version ${{ steps.vars.outputs.version }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v6
        with:
          context: images/base
          file: images/base/Dockerfile
          push: false
          load: true
          platforms: linux/amd64
          build-args: |
            FLUTTER_VERSION=${{ steps.vars.outputs.version }}
          tags: test-flutter:${{ steps.vars.outputs.version }}
          cache-from: type=gha,scope=flutter
          cache-to: type=gha,scope=flutter,mode=max
          provenance: false

      - name: Smoke test
        run: |
          docker run --rm \
            --platform=linux/amd64 \
            test-flutter:${{ steps.vars.outputs.version }} \
            sh -c '
              flutter --version &&
              flutter create test_app &&
              cd test_app &&
              flutter build web
            '

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Decide if this tag is the latest stable semver
        id: latest
        run: |
          set -e
          VERSION="${GITHUB_REF_NAME}"

          echo "Current version: $VERSION"

          if echo "$VERSION" | grep -q '\.pre'; then
            echo "is_latest=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MAX_TAG=$(git tag --list "[0-9]*.[0-9]*.[0-9]*" | sort -V | tail -n1 || true)

          echo "Max stable tag in repo: $MAX_TAG"

          if [ -z "$MAX_TAG" ]; then
            echo "is_latest=true" >> "$GITHUB_OUTPUT"
          elif [ "$VERSION" = "$MAX_TAG" ]; then
            echo "is_latest=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_latest=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.version }}
            type=raw,value=${{ steps.vars.outputs.version }}-base
            type=raw,value=${{ steps.vars.outputs.version }}-web
            type=raw,value=latest,enable=${{ steps.latest.outputs.is_latest == 'true' }}
            type=raw,value=base,enable=${{ steps.latest.outputs.is_latest == 'true' }}
            type=raw,value=web,enable=${{ steps.latest.outputs.is_latest == 'true' }}

          labels: |
            org.opencontainers.image.title=${{ steps.vars.outputs.title || 'Flutter SDK' }}
            org.opencontainers.image.licenses=${{ steps.vars.outputs.licenses || 'BSD-3-Clause' }}
            org.opencontainers.image.description=${{ steps.vars.outputs.description || 'Flutter is an open source framework for building beautiful, natively compiled, multi-platform applications from a single codebase.' }}
            org.opencontainers.image.documentation=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.authors=${{ steps.vars.outputs.authors || 'Artem Zolochevskii' }}
            org.opencontainers.image.vendor=${{ steps.vars.outputs.vendor || 'Artem Zolochevskii' }}
          annotations: |
            org.opencontainers.image.title=${{ steps.vars.outputs.title || 'Flutter SDK' }}
            org.opencontainers.image.licenses=${{ steps.vars.outputs.licenses || 'BSD-3-Clause' }}
            org.opencontainers.image.description=${{ steps.vars.outputs.description || 'Flutter is an open source framework for building beautiful, natively compiled, multi-platform applications from a single codebase.' }}
            org.opencontainers.image.documentation=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.authors=${{ steps.vars.outputs.authors || 'Artem Zolochevskii' }}
            org.opencontainers.image.vendor=${{ steps.vars.outputs.vendor || 'Artem Zolochevskii' }}
        env:
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: images/base
          file: images/base/Dockerfile
          push: true
          platforms: linux/amd64
          build-args: |
            FLUTTER_VERSION=${{ steps.vars.outputs.version }}
          cache-from: type=gha,scope=flutter
          cache-to: type=gha,scope=flutter,mode=max
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
